name: Comprehensive Lint Test

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of lint test to run'
        required: false
        default: 'all'
        type: choice
        options:
        - all
        - go
        - yaml
        - json
        - shell
        - markdown

jobs:
  lint-test:
    runs-on: runner-scale-set-cp
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check tools availability
      run: |
        echo "ðŸ” Checking available tools..."
        echo "Go version:"
        go version || echo "âŒ Go not found"
        echo "golangci-lint version:"
        golangci-lint version || echo "âŒ golangci-lint not found"
        echo "yamllint version:"
        yamllint --version || echo "âŒ yamllint not found"
        echo "jq version:"
        jq --version || echo "âŒ jq not found"
        echo "shellcheck version:"
        shellcheck --version || echo "âŒ shellcheck not found"
        echo "markdownlint version:"
        markdownlint --version || echo "âŒ markdownlint not found"
    
    - name: Setup test files
      run: |
        echo "ðŸ“ Creating test files..."
        
        # Create Go test files
        cat > test_good.go << 'EOF'
        package main
        
        import "fmt"
        
        func main() {
            fmt.Println("Hello, World!")
        }
        EOF
        
        cat > test_bad.go << 'EOF'
        package main
        
        import "fmt"
        
        func main() {
            unused := "this is unused"
            fmt.Println("Hello, World!")
        }
        EOF
        
        # Create YAML test files
        cat > test_good.yaml << 'EOF'
        name: Test
        version: 1.0.0
        steps:
          - name: Step 1
            run: echo "Hello"
        EOF
        
        cat > test_bad.yaml << 'EOF'
        name: Test
        version: 1.0.0
        steps:
        - name: Step 1
          run: echo "Hello"
        - name: Step 2
        run: echo "World"
        EOF
        
        # Create JSON test files
        cat > test_good.json << 'EOF'
        {
          "name": "test",
          "version": "1.0.0",
          "dependencies": {
            "go": "1.21"
          }
        }
        EOF
        
        cat > test_bad.json << 'EOF'
        {
          "name": "test",
          "version": "1.0.0",
          "dependencies": {
            "go": "1.21"
          }
        }
        EOF
        
        # Create Shell test files
        cat > test_good.sh << 'EOF'
        #!/bin/bash
        echo "Hello, World!"
        EOF
        
        cat > test_bad.sh << 'EOF'
        #!/bin/bash
        unused_var="test"
        echo "Hello, World!"
        EOF
        
        # Create Markdown test files
        cat > test_good.md << 'EOF'
        # Test Document
        
        This is a test document with proper formatting.
        
        ## Features
        - Feature 1
        - Feature 2
        EOF
        
        cat > test_bad.md << 'EOF'
        #Test Document
        
        This is a test document with improper formatting.
        
        ##Features
        -Feature 1
        -Feature 2
        EOF
        
        echo "âœ… Test files created"
    
    - name: Test Go linting
      if: ${{ inputs.test_type == 'all' || inputs.test_type == 'go' }}
      run: |
        echo "ðŸ” Testing Go linting..."
        
        # Test good Go code (should pass)
        echo "Testing good Go code..."
        go build -o test_good_bin test_good.go
        if [ $? -eq 0 ]; then
          echo "âœ… Good Go code compiled successfully"
        else
          echo "âŒ Good Go code compilation failed"
          exit 1
        fi
        
        # Test bad Go code (should fail)
        echo "Testing bad Go code with go vet..."
        go vet test_bad.go
        if [ $? -ne 0 ]; then
          echo "âœ… go vet correctly found issues"
        else
          echo "âŒ go vet should have found issues"
          exit 1
        fi
        
        # Test with golangci-lint
        echo "Testing bad Go code with golangci-lint..."
        golangci-lint run test_bad.go
        if [ $? -ne 0 ]; then
          echo "âœ… golangci-lint correctly found issues"
        else
          echo "âŒ golangci-lint should have found issues"
          exit 1
        fi
        
        echo "âœ… Go linting tests passed"
    
    - name: Test YAML linting
      if: ${{ inputs.test_type == 'all' || inputs.test_type == 'yaml' }}
      run: |
        echo "ðŸ” Testing YAML linting..."
        
        # Test good YAML (should pass)
        echo "Testing good YAML..."
        yamllint test_good.yaml
        if [ $? -eq 0 ]; then
          echo "âœ… Good YAML passed validation"
        else
          echo "âŒ Good YAML should have passed validation"
          exit 1
        fi
        
        # Test bad YAML (should fail)
        echo "Testing bad YAML..."
        yamllint test_bad.yaml
        if [ $? -ne 0 ]; then
          echo "âœ… Bad YAML correctly failed validation"
        else
          echo "âŒ Bad YAML should have failed validation"
          exit 1
        fi
        
        echo "âœ… YAML linting tests passed"
    
    - name: Test JSON linting
      if: ${{ inputs.test_type == 'all' || inputs.test_type == 'json' }}
      run: |
        echo "ðŸ” Testing JSON linting..."
        
        # Test good JSON (should pass)
        echo "Testing good JSON..."
        jq empty test_good.json
        if [ $? -eq 0 ]; then
          echo "âœ… Good JSON passed validation"
        else
          echo "âŒ Good JSON should have passed validation"
          exit 1
        fi
        
        # Test bad JSON (should fail)
        echo "Testing bad JSON..."
        jq empty test_bad.json
        if [ $? -ne 0 ]; then
          echo "âœ… Bad JSON correctly failed validation"
        else
          echo "âŒ Bad JSON should have passed validation"
          exit 1
        fi
        
        echo "âœ… JSON linting tests passed"
    
    - name: Test Shell linting
      if: ${{ inputs.test_type == 'all' || inputs.test_type == 'shell' }}
      run: |
        echo "ðŸ” Testing Shell linting..."
        
        # Test good shell script (should pass)
        echo "Testing good shell script..."
        shellcheck test_good.sh
        if [ $? -eq 0 ]; then
          echo "âœ… Good shell script passed validation"
        else
          echo "âŒ Good shell script should have passed validation"
          exit 1
        fi
        
        # Test bad shell script (should fail)
        echo "Testing bad shell script..."
        shellcheck test_bad.sh
        if [ $? -ne 0 ]; then
          echo "âœ… Bad shell script correctly failed validation"
        else
          echo "âŒ Bad shell script should have passed validation"
          exit 1
        fi
        
        echo "âœ… Shell linting tests passed"
    
    - name: Test Markdown linting
      if: ${{ inputs.test_type == 'all' || inputs.test_type == 'markdown' }}
      run: |
        echo "ðŸ” Testing Markdown linting..."
        
        # Test good markdown (should pass)
        echo "Testing good markdown..."
        markdownlint test_good.md
        if [ $? -eq 0 ]; then
          echo "âœ… Good markdown passed validation"
        else
          echo "âŒ Good markdown should have passed validation"
          exit 1
        fi
        
        # Test bad markdown (should fail)
        echo "Testing bad markdown..."
        markdownlint test_bad.md
        if [ $? -ne 0 ]; then
          echo "âœ… Bad markdown correctly failed validation"
        else
          echo "âŒ Bad markdown should have passed validation"
          exit 1
        fi
        
        echo "âœ… Markdown linting tests passed"
    
    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up test files..."
        rm -f test_*.go test_*.yaml test_*.json test_*.sh test_*.md test_*_bin
        echo "âœ… Cleanup completed"
    
    - name: Test Summary
      run: |
        echo "ðŸŽ‰ All lint tests completed successfully!"
        echo "ðŸ“Š Test summary:"
        echo "  - Go linting: âœ…"
        echo "  - YAML linting: âœ…"
        echo "  - JSON linting: âœ…"
        echo "  - Shell linting: âœ…"
        echo "  - Markdown linting: âœ…"
